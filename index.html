<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bionic Hand Project</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 1rem;
      background: #fff;
      border-radius: 8px;
    }
    h1, h2 {
      color: #333;
    }
    pre {
      background: #eee;
      padding: 1rem;
      overflow-x: auto;
      position: relative;
    }
    button.copy {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #007bff;
      color: #fff;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
    }
    .comment-section {
      margin-top: 2rem;
    }
    .comment {
      border: 1px solid #ccc;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 5px;
      background: #fafafa;
    }
    .reply {
      margin-left: 2rem;
      background: #f1f1f1;
    }
    img, video {
      max-width: 100%;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Bionic Hand Project</h1>
    <p>이 프로젝트는 근전도(EMG) 센서를 이용하여 손가락(엄지)의 움직임을 제어하는 의수 시스템입니다. 아두이노와 MYOWARE 2.0 센서를 활용하여 사용자의 근육 신호를 감지하고, 그에 따라 서보모터를 제어하여 실제 손가락 움직임처럼 작동합니다.</p>
    <p><a href="https://gamma.app/docs/EMG--fxp1jqdan0hg2tt" target="_blank">📎 프로젝트 발표 PPT 보기</a></p>

    <h2>아두이노 코드</h2>
    <pre><button class="copy" onclick="copyCode()">Copy</button><code id="code">
#include <Servo.h>

Servo myServo;

const int sensorPin = A0;
const int averageSampleSize = 10;
int sensorReadings[averageSampleSize];
int index = 0;
long total = 0;

long threshold = 0;
const int hysteresis = 5;
const int thresholdOffset = 15;

bool isActivated = false;
int lastServoPosition = 0;
unsigned long lastToggleTime = 0;
const unsigned long debounceTime = 500;

void setup() {
  myServo.attach(9);
  Serial.begin(9600);
  myServo.write(0);
  delay(1000);

  for (int i = 0; i < averageSampleSize; i++) {
    sensorReadings[i] = 0;
  }

  Serial.println("Pre-filling readings buffer...");
  for (int i = 0; i < averageSampleSize; i++) {
    int val = analogRead(sensorPin);
    sensorReadings[i] = val;
    total += val;
    delay(20);
  }

  Serial.println("CALIBRATION: Relax your muscle for 5 seconds...");
  long sum = 0;
  int maxVal = 0;
  int minVal = 1023;
  const int calibrationSamples = 100;

  for (int i = 0; i < calibrationSamples; i++) {
    int val = analogRead(sensorPin);
    sum += val;
    maxVal = max(maxVal, val);
    minVal = min(minVal, val);
    if (i % 10 == 0) {
      Serial.print("Sample ");
      Serial.print(i);
      Serial.print(": ");
      Serial.println(val);
    }
    delay(50);
  }

  long baseline = sum / calibrationSamples;
  int variance = maxVal - minVal;
  threshold = baseline + thresholdOffset;

  Serial.println("\n--- Calibration Results ---");
  Serial.print("Min value: "); Serial.println(minVal);
  Serial.print("Max value: "); Serial.println(maxVal);
  Serial.print("Baseline: "); Serial.println(baseline);
  Serial.print("Variance: "); Serial.println(variance);
  Serial.print("Threshold set to: "); Serial.println(threshold);
  Serial.println("-------------------------");
  Serial.println("Now flex your muscle to test!");
}

void loop() {
  int newValue = analogRead(sensorPin);
  total -= sensorReadings[index];
  sensorReadings[index] = newValue;
  total += sensorReadings[index];
  index = (index + 1) % averageSampleSize;

  int avgValue = total / averageSampleSize;

  Serial.print("Raw: "); Serial.print(newValue);
  Serial.print(" | Avg: "); Serial.print(avgValue);
  Serial.print(" | Threshold: "); Serial.print(threshold);

  unsigned long currentTime = millis();
  if (avgValue > threshold && !isActivated && (currentTime - lastToggleTime > debounceTime)) {
    toggleServo();
    isActivated = true;
    lastToggleTime = currentTime;
    Serial.print(" | ACTIVATED!");
  }

  if (avgValue < (threshold - hysteresis)) {
    isActivated = false;
  }

  Serial.println();
  delay(50);
}

void toggleServo() {
  int target = (lastServoPosition == 0) ? 180 : 0;
  int step = (target > lastServoPosition) ? 5 : -5;
  for (int pos = lastServoPosition; pos != target; pos += step) {
    myServo.write(pos);
    delay(15);
  }
  myServo.write(target);
  lastServoPosition = target;
  Serial.print("Servo toggled to: ");
  Serial.println(target);
}</code></pre>

    <div class="comment-section">
      <h2>리뷰 및 댓글</h2>
      <div id="comments"></div>
      <textarea id="comment-input" placeholder="댓글을 입력하세요"></textarea><br/>
      <input type="text" id="media-url" placeholder="사진 또는 동영상 URL (선택)" /><br/>
      <button onclick="addComment()">댓글 작성</button>
    </div>
  </div>

  <script>
    function copyCode() {
      const code = document.getElementById("code").innerText;
      navigator.clipboard.writeText(code).then(() => {
        alert("코드가 복사되었습니다!");
      });
    }

    let commentId = 0;
    function addComment(parentId = null) {
      const input = document.getElementById('comment-input');
      const media = document.getElementById('media-url');
      const commentsDiv = document.getElementById('comments');
      const text = input.value.trim();
      const mediaLink = media.value.trim();
      if (!text) return;

      const div = document.createElement('div');
      div.className = parentId ? 'comment reply' : 'comment';
      div.id = `comment-${commentId++}`;

      div.innerHTML = `<p>${text}</p>`;
      if (mediaLink) {
        if (mediaLink.endsWith('.mp4')) {
          div.innerHTML += `<video src="${mediaLink}" controls></video>`;
        } else {
          div.innerHTML += `<img src="${mediaLink}" />`;
        }
      }
      div.innerHTML += `<button onclick="replyTo('${div.id}')">답글</button>
                        <button onclick="deleteComment('${div.id}')">삭제</button>`;
      if (parentId) {
        document.getElementById(parentId).appendChild(div);
      } else {
        commentsDiv.appendChild(div);
      }
      input.value = '';
      media.value = '';
    }

    function replyTo(id) {
      const text = prompt("답글을 입력하세요:");
      if (text) {
        const replyDiv = document.createElement('div');
        replyDiv.className = 'comment reply';
        replyDiv.innerHTML = `<p>${text}</p>
                              <button onclick="deleteComment(this.parentNode.id)">삭제</button>`;
        replyDiv.id = `comment-${commentId++}`;
        document.getElementById(id).appendChild(replyDiv);
      }
    }

    function deleteComment(id) {
      const comment = document.getElementById(id);
      if (comment) comment.remove();
    }
  </script>
</body>
</html>
